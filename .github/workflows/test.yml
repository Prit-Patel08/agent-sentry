name: CI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "CHANGELOG.md"
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "CHANGELOG.md"
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run shellcheck on scripts
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: ./scripts

  tooling-doctor:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install pinned Go toolchain helpers
        run: bash ./scripts/install_go_tools.sh

      - name: Run tooling doctor (strict)
        run: ./scripts/tooling_doctor.sh --strict --summary-file ci_artifacts/tooling/summary.tsv

      - name: Upload tooling doctor artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tooling-doctor
          path: ci_artifacts/tooling

  release-checkpoint-contract:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [shellcheck, tooling-doctor]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Run release checkpoint contract tests
        run: ./scripts/release_checkpoint_contract_test.sh

      - name: Run tooling doctor contract tests
        run: ./scripts/tooling_doctor_contract_test.sh

      - name: Run replay retention contract tests
        run: ./scripts/controlplane_replay_retention_contract_test.sh

      - name: Run SLO weekly review contract tests
        run: ./scripts/slo_weekly_review_contract_test.sh

      - name: Run git hook installer contract tests
        run: ./scripts/install_git_hook_contract_test.sh

  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [release-checkpoint-contract]
    env:
      GO_BUILD_PKGS: ". ./cmd/... ./internal/..."
      GO_TEST_PKGS: ". ./cmd/... ./internal/... ./test"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Print Go Toolchain
        run: |
          go version
          go env GOVERSION GOROOT

      - name: Install pinned Go toolchain helpers
        run: bash ./scripts/install_go_tools.sh

      - name: Build
        run: go build $GO_BUILD_PKGS

      - name: Test
        run: go test $GO_TEST_PKGS -v

      - name: Race Detector
        run: go test $GO_TEST_PKGS -race -v

      - name: Vet
        run: go vet $GO_TEST_PKGS

      - name: Supervisor Teardown Reliability Gate
        run: go test ./internal/supervisor -run TestStopTerminatesDeepProcessTree -count=3 -v

      - name: Benchmark Corpus Gate
        run: ./scripts/benchmark_corpus.sh ci_artifacts/corpus

      - name: Upload benchmark corpus artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-corpus
          path: ci_artifacts/corpus

      - name: Staticcheck
        run: |
          "$(go env GOPATH)/bin/staticcheck" $GO_TEST_PKGS

      - name: Govulncheck
        run: |
          "$(go env GOPATH)/bin/govulncheck" $GO_TEST_PKGS

  dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: dashboard
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build dashboard
        run: npm run build

  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [backend, dashboard]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: dashboard/package-lock.json

      - name: Run smoke gate
        run: ./scripts/smoke_local.sh ci_artifacts/smoke

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-gate
          path: ci_artifacts/smoke

  replay-drill:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [backend]
    env:
      FLOWFORGE_API_KEY: ci-replay-drill-key
      FLOWFORGE_DB_PATH: ci_artifacts/replay-drill/flowforge.db
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Build FlowForge binary
        run: go build -o flowforge .

      - name: Run live control-plane replay drill
        run: |
          mkdir -p ci_artifacts/replay-drill
          ./flowforge dashboard >ci_artifacts/replay-drill/dashboard.log 2>&1 &
          api_pid=$!
          cleanup() {
            kill "$api_pid" >/dev/null 2>&1 || true
            wait "$api_pid" 2>/dev/null || true
          }
          trap cleanup EXIT

          for i in $(seq 1 40); do
            if curl -fsS http://127.0.0.1:8080/healthz >/dev/null 2>&1; then
              break
            fi
            sleep 0.25
          done
          curl -fsS http://127.0.0.1:8080/healthz >/dev/null

          ./scripts/controlplane_replay_drill.sh \
            --api-key "$FLOWFORGE_API_KEY" \
            --out ci_artifacts/replay-drill/artifacts

      - name: Upload replay drill artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: replay-drill
          path: ci_artifacts/replay-drill

  docker:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [backend]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build runtime image
        run: docker build -t flowforge-ci -f Dockerfile .

      - name: Verify non-root user
        run: |
          USER_CFG="$(docker image inspect -f '{{.Config.User}}' flowforge-ci)"
          test "$USER_CFG" = "65532:65532"

      - name: Verify healthcheck command
        run: |
          HEALTH_CFG="$(docker image inspect -f '{{json .Config.Healthcheck.Test}}' flowforge-ci)"
          echo "$HEALTH_CFG"
          echo "$HEALTH_CFG" | grep '"/probe"'

      - name: Runtime health smoke
        run: |
          docker run -d --name flowforge-runtime --entrypoint /flowforge flowforge-ci dashboard
          for i in $(seq 1 40); do
            STATUS="$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' flowforge-runtime)"
            if [ "$STATUS" = "healthy" ]; then
              exit 0
            fi
            sleep 1
          done
          docker logs flowforge-runtime
          exit 1

      - name: Cleanup runtime container
        if: always()
        run: |
          docker logs flowforge-runtime || true
          docker rm -f flowforge-runtime || true

  sbom:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
